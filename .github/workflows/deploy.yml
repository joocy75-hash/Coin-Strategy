# GitHub Actions - Auto Deploy to Hetzner Server
# main Î∏åÎûúÏπòÏóê push Ïãú ÏûêÎèôÏúºÎ°ú ÏõêÍ≤© ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_IP: 141.164.55.245
  DEPLOY_PATH: /root/service_c/strategy-research-lab

jobs:
  deploy:
    name: Deploy to New Server
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
          # SSH Ïó∞Í≤∞ Ïú†ÏßÄ ÏÑ§Ï†ï
          echo "Host *" >> ~/.ssh/config
          echo "  ServerAliveInterval 60" >> ~/.ssh/config
          echo "  ServerAliveCountMax 10" >> ~/.ssh/config
          echo "  TCPKeepAlive yes" >> ~/.ssh/config

      - name: Create .env file on server
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ssh root@$SERVER_IP "mkdir -p $DEPLOY_PATH && cat > $DEPLOY_PATH/.env << 'ENVFILE'
          ANTHROPIC_API_KEY=${ANTHROPIC_KEY}
          DB_PATH=data/strategies.db
          MAX_STRATEGIES=50
          MIN_LIKES=500
          HEADLESS=true
          TIMEOUT=30000
          LLM_MODEL=claude-3-5-sonnet-20241022
          SKIP_LLM=false
          MAX_RETRIES=3
          OUTPUT_DIR=data/converted
          LOGS_DIR=logs
          RATE_LIMIT_DELAY=1.0
          ENVFILE"

      - name: Deploy to server
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.pytest_cache' \
            --exclude 'venv' \
            --exclude '.env' \
            --exclude 'data/' \
            --exclude 'logs/' \
            ./ root@$SERVER_IP:$DEPLOY_PATH/

      - name: Build Docker images
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 root@$SERVER_IP "cd $DEPLOY_PATH && \
            mkdir -p data logs data/converted data/reports && \
            chmod -R 777 logs data && \
            docker system prune -af --volumes 2>/dev/null || true && \
            docker network create proxy-net 2>/dev/null || true && \
            docker compose down --remove-orphans 2>/dev/null || true && \
            docker compose build --parallel 2>&1 | tail -50"

      - name: Start containers
        run: |
          ssh root@$SERVER_IP "cd $DEPLOY_PATH && \
            chmod -R 777 logs data && \
            docker compose up -d && \
            sleep 5 && \
            docker compose ps"

      - name: Health Check
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://$SERVER_IP:8081/api/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Health check passed on attempt $i!"
              exit 0
            fi
            echo "Attempt $i: response=$response. Retrying in 10s..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after 5 attempts."
          ssh root@$SERVER_IP "docker compose -f $DEPLOY_PATH/docker-compose.yml ps"
          ssh root@$SERVER_IP "docker compose -f $DEPLOY_PATH/docker-compose.yml logs --tail=50"
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üîó API URL: http://$SERVER_IP/api/docs"

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            MSG="Strategy Research Lab Î∞∞Ìè¨ ÏÑ±Í≥µ!"
          else
            EMOJI="‚ùå"
            MSG="Strategy Research Lab Î∞∞Ìè¨ Ïã§Ìå®!"
          fi
          
          TEXT="${EMOJI} ${MSG}%0AÏÑúÎ≤Ñ: ${SERVER_IP}%0AÏãúÍ∞Ñ: $(date '+%Y-%m-%d %H:%M:%S')"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${TEXT}" || true
