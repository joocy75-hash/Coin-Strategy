<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Strategy Lab - Integrated Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-deep: #020202;
        --bg-surface: #0a0a0a;
        --bg-card: linear-gradient(145deg, #0f0f0f, #050505);
        --bg-glass: rgba(5, 5, 5, 0.85);
        --accent-primary: #f2f2f2; /* Silver/Off-white */
        --accent-emerald: #10b981; /* Keep only for status/positive stats */
        --text-primary: #ffffff;
        --text-secondary: #888888;
        --border-color: #1a1a1a;
        --border-enamel: #222222;
        --danger: #ff4d4d;
        --warning: #ffcc00;
        --shadow-enamel: 0 10px 30px -10px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255, 255, 255, 0.05);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", "Noto Sans KR", sans-serif;
        background: radial-gradient(circle at 50% 0%, #111 0%, #020202 70%);
        color: var(--text-primary);
        display: flex;
        height: 100vh; /* Changed from min-height: 100vh to fit viewport */
        overflow: hidden; /* Body doesn't scroll, children do */
      }

      .sidebar {
        width: 260px;
        height: 100vh; /* Sidebar takes full height */
        background: var(--bg-deep);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 32px 24px;
        z-index: 100;
        box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
        overflow-y: auto; /* Enable scroll if items exceed height */
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--accent-primary);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        color: #000;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      }

      .logo-text {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        color: #ffffff;
      }

      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 14px;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .nav-item:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.03);
      }

      .nav-item.active {
        color: var(--text-primary);
        background: #111;
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-enamel);
      }

      .nav-item i {
        font-size: 1.1rem;
        width: 20px;
        filter: grayscale(1) brightness(1.5); /* Monochrome effect */
        opacity: 0.7;
        transition: all 0.3s;
      }

      .nav-item.active i {
        opacity: 1;
        filter: grayscale(1) brightness(2);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: 32px;
        overflow-y: auto;
        position: relative;
      }

      /* Top Header */
      .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
      }

      .server-status {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #000;
        padding: 6px 14px;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid var(--border-enamel);
        box-shadow: var(--shadow-enamel);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-primary);
        box-shadow: 0 0 10px var(--accent-primary);
      }

      .status-dot.danger {
        background: var(--danger);
        box-shadow: 0 0 10px var(--danger);
      }

      /* Tab Content */
      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Cards and Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .card {
        background: var(--bg-card);
        border: 1px solid var(--border-enamel);
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-enamel);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
      }

      .stat-profit {
        color: var(--accent-primary);
      }
      .stat-loss {
        color: var(--danger);
      }

      /* Tables */
      .table-area {
        background: var(--bg-surface);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-top: 24px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
      }

      th {
        background: #050505;
        padding: 14px 16px;
        font-weight: 700;
        color: #555;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--border-color);
      }

      td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.875rem;
        color: #ddd;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .grade-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.75rem;
      }

      .grade-a {
        background: rgba(16, 185, 129, 0.2);
        color: var(--accent-primary);
      }
      .grade-b {
        background: rgba(59, 130, 246, 0.2);
        color: var(--accent-secondary);
      }
      .grade-c {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .btn-primary {
        background: linear-gradient(180deg, #333, #000);
        color: #fff;
        border: 1px solid #444;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      }

      .btn-primary:hover {
        background: linear-gradient(180deg, #444, #111);
        border-color: #666;
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-outline {
        background: transparent;
        color: #fff;
        border: 1px solid var(--border-enamel);
      }

      .btn-outline:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: #666;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        padding: 32px;
      }

      .modal-close {
        position: absolute;
        top: 24px;
        right: 24px;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
      }

      /* Controls */
      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      input,
      select {
        background: var(--bg-deep);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 10px 16px;
        border-radius: 8px;
        outline: none;
      }

      input:focus {
        border-color: var(--accent-primary);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-deep);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Badges and Tags */
      .source-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        text-transform: uppercase;
        margin-right: 4px;
      }
      .source-custom { background: rgba(16, 185, 129, 0.2); color: var(--accent-primary); }
      .source-freq { background: rgba(59, 130, 246, 0.2); color: var(--accent-secondary); }

      /* Scaled Iframe Container */
      .iframe-scaler-container {
        width: 100%;
        height: 800px;
        overflow: hidden;
        border-radius: 12px;
        border: 1px solid var(--border-enamel);
        background: #000;
      }
      .iframe-scaler-container.large {
        height: 850px;
      }
      .scaled-iframe {
        width: 142.86%; /* 100% / 0.7 */
        height: 142.86%; /* 100% / 0.7 */
        transform: scale(0.7);
        transform-origin: 0 0;
        border: none;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-area">
        <div class="logo-icon">S</div>
        <div class="logo-text">Strategy Lab</div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
          <i>âŠ</i> <span>ëŒ€ì‹œë³´ë“œ</span>
        </div>
        <div class="nav-item" data-tab="intelligence" onclick="switchTab('intelligence')">
          <i>â—ˆ</i> <span>ë§ˆì¼“ ì¸í…”ë¦¬ì „ìŠ¤</span>
        </div>
        <div class="nav-item" data-tab="live" onclick="switchTab('live')">
          <i>âŒ</i> <span>ì‹¤ì „ë§¤ë§¤</span>
        </div>
        <div class="nav-item" data-tab="freqtrade" onclick="switchTab('freqtrade')">
          <i>â¬¡</i> <span>FreqControl</span>
        </div>
        <div class="nav-item" data-tab="freqbacktest" onclick="switchTab('freqbacktest')">
          <i>âš—</i> <span>FreqBacktest</span>
        </div>
        <div class="nav-item" data-tab="hummingbot" onclick="switchTab('hummingbot')">
          <i>âŠ</i> <span>Hummingbot</span>
        </div>
        <div class="nav-item" data-tab="cryptovision" onclick="switchTab('cryptovision')">
          <i>â€</i> <span>CryptoVision</span>
        </div>
        <div class="nav-item" data-tab="messari" onclick="switchTab('messari')">
          <i>â–¤</i> <span>Messari</span>
        </div>
        <div class="nav-item" data-tab="cryptopanic" onclick="switchTab('cryptopanic')">
          <i>âŒ½</i> <span>CryptoPanic</span>
        </div>
        <div class="nav-item" data-tab="perplexity" onclick="switchTab('perplexity')">
          <i>â›—</i> <span>PPLX Finance</span>
        </div>
        <div class="nav-item" data-tab="explorer" onclick="switchTab('explorer')">
          <i>â—‹</i> <span>ì „ëµ íƒìƒ‰</span>
        </div>
        <div class="nav-item" data-tab="backtest" onclick="switchTab('backtest')">
          <i>â–¡</i> <span>Pine ë°±í…ŒìŠ¤íŠ¸</span>
        </div>
      </nav>

      <div
        style="
          margin-top: auto;
          padding-top: 20px;
          border-top: 1px solid var(--border-color);
        "
      >
        <div class="nav-item" onclick="promptApiKey()">
          <i>ğŸ”‘</i> <span id="apiKeyLabel">ë³´ì•ˆ í‚¤ ì„¤ì •</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <header class="top-header">
        <h1 id="tabTitle">ì¢…í•© ìƒíƒœ ëŒ€ì‹œë³´ë“œ</h1>
        <div class="server-status">
          <div class="status-dot" id="serverPulse"></div>
          <span id="serverStatusText">ì‹œìŠ¤í…œ ì •ìƒ</span>
          <span
            style="color: var(--text-secondary); margin-left: 8px"
            id="lastUpdate"
            >12:00:00</span
          >
        </div>
      </header>

      <!-- INTELLIGENCE TAB -->
      <div id="tab-intelligence" class="tab-content">
        <div class="stats-grid">
          <div class="card">
            <div class="stat-label">AI ë§ˆì¼“ ì„¼í‹°ë¨¼íŠ¸ (HuggingFace)</div>
            <div id="intelSentimentStatus" class="stat-value" style="color: var(--accent-emerald)">BULLISH</div>
            <div id="intelSentimentIndex" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Fear & Greed Index: 65</div>
          </div>
          <div class="card">
            <div class="stat-label">ì‹¤ì‹œê°„ ë¶„ì„ ìš”ì•½</div>
            <div id="intelSummary" style="font-size: 0.9rem; margin-top: 8px; line-height: 1.5;">ê¸°ê´€ íˆ¬ììë“¤ì˜ ë¹„íŠ¸ì½”ì¸ í˜„ë¬¼ ETF ë§¤ìˆ˜ì„¸ê°€ ì§€ì†ë˜ë©° ì‹œì¥ ì „ë°˜ì— ê¸ì •ì ì¸ ì‹¬ë¦¬ê°€ í™•ì‚°ë˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
          </div>
          <div class="card">
            <div class="stat-label">í•µì‹¬ ë°ì´í„° ì†ŒìŠ¤</div>
            <div style="font-size: 0.8rem; margin-top: 8px; color: var(--text-secondary)">
              <div>â€¢ Twitter/X Sentiment Analysis</div>
              <div>â€¢ CryptoBERT NLP Engine</div>
              <div>â€¢ Brave News Aggregator</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 20px;">â—ˆ ì‹¤ì‹œê°„ ë§¤í¬ë¡œ ì†Œì‹ (Brave & Playwright)</h3>
          <div id="intelNewsList" class="table-area" style="background: transparent; border: none;">
            <div style="text-align:center; padding: 40px;">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <!-- HUMMINGBOT TAB -->
      <div id="tab-hummingbot" class="tab-content">
          <div class="card" style="margin-bottom: 24px;">
              <h3 style="margin-bottom: 12px;">âŠ Hummingbot AMM & Arbitrage</h3>
              <p style="color: var(--text-secondary); margin-bottom: 20px;">ì‹œì¥ ì¡°ì„±(Market Making) ë° ì°¨ìµ ê±°ë˜(Arbitrage) ì „ë¬¸ ì—”ì§„ì…ë‹ˆë‹¤.</p>
              <div class="stats-grid">
                  <div class="card" style="background: rgba(255,255,255,0.02)">
                      <div class="stat-label">ìƒíƒœ</div>
                      <div style="font-weight: 700; color: var(--accent-emerald)">READY</div>
                  </div>
                  <div class="card" style="background: rgba(255,255,255,0.02)">
                      <div class="stat-label">í™œì„± ì „ëµ</div>
                      <div style="font-weight: 700;">Simple PMM</div>
                  </div>
                  <div class="card" style="background: rgba(255,255,255,0.02)">
                      <div class="stat-label">ë²„ì „</div>
                      <div style="font-weight: 700;">v2.11.0 (Latest)</div>
                  </div>
              </div>
          </div>
          <div class="iframe-scaler-container">
              <iframe id="hummingbotIframe" src="about:blank" class="scaled-iframe"></iframe>
          </div>
      </div>

      <!-- EXTERNAL TOOLS TABS -->
      <div id="tab-cryptovision" class="tab-content">
          <div class="card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; padding: 12px 24px;">
              <div>
                <h3 style="font-size: 1rem;">â—ˆ CryptoVision AI ë¶„ì„</h3>
                <p style="font-size: 0.75rem; color: var(--text-secondary);">HuggingFace ê¸°ë°˜ ì‹¤ì‹œê°„ ê°€ìƒìì‚° ì‹œê°í™” ë„êµ¬</p>
              </div>
              <a href="https://huggingface.co/spaces/openfree/CryptoVision" target="_blank" class="btn btn-outline" style="font-size:0.75rem;">ìƒì„¸ ë¶„ì„ ì—´ê¸° â†—</a>
          </div>
          <!-- Using the direct hf.space link for better embedding compatibility -->
          <iframe id="ifrCryptoVision" src="about:blank" style="width: 100%; height: 800px; border: 1px solid var(--border-enamel); border-radius: 12px; background: #000;"></iframe>
      </div>

      <div id="tab-messari" class="tab-content">
          <!-- Messari Top Assets -->
          <div class="card" style="margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem;">â–¤ Messari ìì‚° ìŠ¤í¬ë¦¬ë„ˆ</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="loadMessariAssets()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                  <span id="messariStatus" class="grade-badge grade-a" style="font-size: 0.7rem;">LOADING...</span>
                </div>
              </div>
              <div class="table-area" style="max-height: 400px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>ìì‚°</th>
                      <th>ê°€ê²© (USD)</th>
                      <th>24h ë³€ë™</th>
                      <th>ê±°ë˜ëŸ‰ (24h)</th>
                      <th>ì‹œê°€ì´ì•¡</th>
                    </tr>
                  </thead>
                  <tbody id="messariAssetsBody">
                    <tr><td colspan="5" style="text-align:center; padding: 40px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                  </tbody>
                </table>
              </div>
          </div>

          <!-- Messari News -->
          <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem;">ğŸ“° Messari ë¦¬ì„œì¹˜ & ë‰´ìŠ¤</h3>
                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="loadMessariNews()">ğŸ”„</button>
              </div>
              <div id="messariNewsList" style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                <div style="text-align:center; padding: 40px; color: var(--text-secondary);">ë‰´ìŠ¤ ë¡œë”© ì¤‘...</div>
              </div>
          </div>

          <div style="text-align: right; margin-top: 16px;">
            <a href="https://messari.io/screener" target="_blank" class="btn btn-outline" style="font-size: 0.8rem;">Messari ì „ì²´ ìŠ¤í¬ë¦¬ë„ˆ ì—´ê¸° â†—</a>
          </div>
      </div>

      <div id="tab-cryptopanic" class="tab-content">
          <div class="card" style="margin-bottom: 20px; padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 1.1rem;">âŒ½ CryptoPanic High-Impact Feed</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <select id="cpFilter" onchange="loadCryptoPanicNews()" style="padding: 6px 12px; border-radius: 6px; font-size: 0.75rem;">
                    <option value="hot">ğŸ”¥ Hot</option>
                    <option value="rising">ğŸ“ˆ Rising</option>
                    <option value="bullish">ğŸ‚ Bullish</option>
                    <option value="bearish">ğŸ» Bearish</option>
                    <option value="important">âš¡ Important</option>
                  </select>
                  <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="loadCryptoPanicNews()">ğŸ”„</button>
                  <span id="cpStatus" class="grade-badge grade-a" style="font-size: 0.7rem;">LOADING...</span>
                </div>
              </div>
              <div id="cryptoPanicLiveList" style="display: flex; flex-direction: column; gap: 12px; max-height: 700px; overflow-y: auto;">
                <div style="text-align:center; padding: 40px; color: var(--text-secondary);">ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</div>
              </div>
          </div>
          <div style="text-align: right;">
            <a href="https://cryptopanic.com/" target="_blank" class="btn btn-outline" style="font-size: 0.8rem;">CryptoPanic ì›ë³¸ ì‚¬ì´íŠ¸ ë³´ê¸° â†—</a>
          </div>
      </div>

      <div id="tab-perplexity" class="tab-content">
          <!-- Header with tabs like Perplexity Finance -->
          <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 1.2rem;">â‚¿</span>
              <span style="font-weight: 600;">ì•”í˜¸í™”í</span>
            </div>
            <div class="pplx-tab active" onclick="switchPplxTab('crypto')" data-pplx-tab="crypto" style="cursor:pointer; padding: 8px 0; border-bottom: 2px solid var(--accent-primary);">ì•”í˜¸í™”í</div>
            <div class="pplx-tab" onclick="switchPplxTab('stocks')" data-pplx-tab="stocks" style="cursor:pointer; padding: 8px 0; color: var(--text-secondary);">ë¯¸êµ­ ì‹œì¥</div>
            <div class="pplx-tab" onclick="switchPplxTab('macro')" data-pplx-tab="macro" style="cursor:pointer; padding: 8px 0; color: var(--text-secondary);">ë§¤í¬ë¡œ</div>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 0.75rem; color: var(--text-secondary);" id="pplxSentiment">||||||||</span>
              <span id="pplxSentimentLabel" style="font-size: 0.75rem; color: var(--danger);">ë¹„ê´€ì  ê°ì •</span>
              <span style="font-size: 0.75rem; color: var(--text-secondary);">â€¢ ì‹œì¥ ë§ˆê°</span>
            </div>
          </div>

          <!-- Index Cards Grid (like Perplexity Finance) -->
          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="font-size: 0.9rem; color: var(--text-secondary);">ì§€ìˆ˜ ë³€ë™</h3>
              <button class="btn btn-outline" style="padding: 4px 10px; font-size: 0.7rem;" onclick="loadPplxIndices()">ğŸ”„</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;" id="pplxIndicesGrid">
              <!-- BTC Card -->
              <div class="pplx-index-card" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600;">Bitcoin</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">BTC/USD</div>
                  </div>
                  <div style="text-align: right;">
                    <div id="pplxBtcChange" style="color: var(--danger); font-size: 0.85rem;">â†˜ 0.00%</div>
                    <div id="pplxBtcDiff" style="font-size: 0.75rem; color: var(--danger);">-$0.00</div>
                  </div>
                </div>
                <div id="pplxBtcChart" style="height: 60px; background: linear-gradient(180deg, rgba(255,77,77,0.1) 0%, transparent 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                <div id="pplxBtcPrice" style="font-size: 1.25rem; font-weight: 700;">US$0.00</div>
              </div>

              <!-- ETH Card -->
              <div class="pplx-index-card" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600;">Ethereum</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">ETH/USD</div>
                  </div>
                  <div style="text-align: right;">
                    <div id="pplxEthChange" style="color: var(--danger); font-size: 0.85rem;">â†˜ 0.00%</div>
                    <div id="pplxEthDiff" style="font-size: 0.75rem; color: var(--danger);">-$0.00</div>
                  </div>
                </div>
                <div id="pplxEthChart" style="height: 60px; background: linear-gradient(180deg, rgba(255,77,77,0.1) 0%, transparent 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                <div id="pplxEthPrice" style="font-size: 1.25rem; font-weight: 700;">US$0.00</div>
              </div>

              <!-- SOL Card -->
              <div class="pplx-index-card" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600;">Solana</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">SOL/USD</div>
                  </div>
                  <div style="text-align: right;">
                    <div id="pplxSolChange" style="color: var(--accent-emerald); font-size: 0.85rem;">â†— 0.00%</div>
                    <div id="pplxSolDiff" style="font-size: 0.75rem; color: var(--accent-emerald);">+$0.00</div>
                  </div>
                </div>
                <div id="pplxSolChart" style="height: 60px; background: linear-gradient(180deg, rgba(16,185,129,0.1) 0%, transparent 100%); border-radius: 8px; margin-bottom: 8px;"></div>
                <div id="pplxSolPrice" style="font-size: 1.25rem; font-weight: 700;">US$0.00</div>
              </div>

              <!-- Fear & Greed Index Card -->
              <div class="pplx-index-card" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600;">Fear & Greed</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">ì‹œì¥ ì‹¬ë¦¬</div>
                  </div>
                  <div style="text-align: right;">
                    <div id="pplxFgLabel" style="color: var(--warning); font-size: 0.85rem;">Neutral</div>
                  </div>
                </div>
                <div style="height: 60px; display: flex; align-items: center; justify-content: center;">
                  <div id="pplxFgGauge" style="width: 100%; height: 8px; background: linear-gradient(90deg, var(--danger), var(--warning), var(--accent-emerald)); border-radius: 4px; position: relative;">
                    <div id="pplxFgPointer" style="position: absolute; top: -6px; left: 50%; width: 4px; height: 20px; background: #fff; border-radius: 2px; transform: translateX(-50%);"></div>
                  </div>
                </div>
                <div id="pplxFgValue" style="font-size: 1.25rem; font-weight: 700;">50</div>
              </div>
            </div>
          </div>

          <!-- Market Summary Section (like Perplexity) -->
          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="font-size: 0.9rem; color: var(--text-secondary);">ì‹œì¥ ìš”ì•½</h3>
              <span id="pplxSummaryTime" style="font-size: 0.75rem; color: var(--text-secondary);">ì—…ë°ì´íŠ¸ë¨ --</span>
            </div>
            <div id="pplxMarketSummary" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
              <div style="padding: 20px; text-align: center; color: var(--text-secondary);">ì‹œì¥ ìš”ì•½ì„ ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <!-- Search Input (like Perplexity) -->
          <div style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <input type="text" id="pplxQuery" placeholder="ì•”í˜¸í™”í ì‹œì¥ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ì§ˆë¬¸í•˜ì„¸ìš”" style="flex: 1; padding: 16px 20px; border-radius: 12px; font-size: 1rem; background: var(--bg-deep); border: 1px solid var(--border-color);" onkeypress="if(event.key==='Enter') askPerplexity()">
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button class="btn btn-primary" style="padding: 10px 16px; border-radius: 50%;" onclick="askPerplexity()">ğŸ”</button>
              <button class="btn btn-outline" style="padding: 10px 16px; border-radius: 50%;" title="ë”¥ ë¦¬ì„œì¹˜">âœ¨</button>
              <button class="btn btn-outline" style="padding: 10px 16px; border-radius: 50%;" title="ë¹„êµ ë¶„ì„">âŠ</button>
              <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="setQuickQuery('ë¹„íŠ¸ì½”ì¸ ì˜¤ëŠ˜ ê°€ê²© ì „ë§')">BTC ì „ë§</button>
                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="setQuickQuery('ì´ë”ë¦¬ì›€ ë ˆì´ì–´2 í˜„í™©')">ETH L2</button>
                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.75rem;" onclick="setQuickQuery('ì•ŒíŠ¸ì½”ì¸ ì‹œì¦Œ ì‹ í˜¸')">ì•ŒíŠ¸ì½”ì¸</button>
              </div>
            </div>
          </div>

          <!-- AI Response Area -->
          <div id="pplxResponseArea" style="margin-top: 24px; display: none;">
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 1rem;">ğŸ’¡ AI ë¶„ì„ ê²°ê³¼</h3>
                <span id="pplxChatStatus" class="grade-badge grade-a" style="font-size: 0.7rem;">READY</span>
              </div>
              <div id="pplxChatHistory" style="line-height: 1.8; font-size: 0.95rem;"></div>
            </div>
          </div>

          <div style="text-align: right; margin-top: 16px;">
            <a href="https://www.perplexity.ai/finance" target="_blank" class="btn btn-outline" style="font-size: 0.8rem;">Perplexity Finance ì—´ê¸° â†—</a>
          </div>
      </div>

      <!-- DASHBOARD TAB -->
      <div id="tab-dashboard" class="tab-content active">
        <!-- API KEY STORAGE (Hidden) -->
        <div id="externalApiStorage" style="display:none;" 
             data-messari=""
             data-cryptopanic=""
             data-perplexity="">
        </div>
        <div class="stats-grid">
          <div class="card">
            <div class="stat-label">ì‹¤ì‹œê°„ ì´ ì†ìµ</div>
            <div class="stat-value stat-profit" id="dashPnl">+$0.00</div>
          </div>
          <div class="card">
            <div class="stat-label">ìë™ë§¤ë§¤ ìŠ¹ë¥ </div>
            <div class="stat-value" id="dashWinRate">0%</div>
          </div>
          <div class="card">
            <div class="stat-label">ìˆ˜ì§‘ëœ ì´ ì „ëµ</div>
            <div class="stat-value" id="dashTotalStrats">0</div>
          </div>
          <div class="card">
            <div class="stat-label">ìš°ìˆ˜ ì „ëµ (B+)</div>
            <div
              class="stat-value"
              style="color: var(--accent-secondary)"
              id="dashVerifiedStrats"
            >
              0
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px">
          <div class="card">
            <h3 style="margin-bottom: 20px">ğŸ”¥ ìƒìœ„ ê²€ì¦ ì „ëµ</h3>
            <div id="topStrategiesList">
              ë¡œë”© ì¤‘...
            </div>
          </div>
          <div class="card">
            <h3 style="margin-bottom: 20px">ğŸ›¡ï¸ ì•ˆì „ì¥ì¹˜ ê°€ë™ í˜„í™©</h3>
            <ul
              style="
                list-style: none;
                display: flex;
                flex-direction: column;
                gap: 16px;
              "
            >
              <li style="display: flex; justify-content: space-between">
                <span color="var(--text-secondary)">ì¼ì¼ ì†ì‹¤ í•œë„</span>
                <span id="dashLossLimit" style="font-weight: 600">-</span>
              </li>
              <li style="display: flex; justify-content: space-between">
                <span color="var(--text-secondary)">ìµœëŒ€ í¬ì§€ì…˜ ë¹„ì¤‘</span>
                <span id="dashPosLimit" style="font-weight: 600">-</span>
              </li>
              <li style="display: flex; justify-content: space-between">
                <span color="var(--text-secondary)">ì—°ì† ì†ì‹¤ ì°¨ë‹¨</span>
                <span id="dashConsecLimit" style="font-weight: 600">-</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- LIVE TRADING TAB -->
      <div id="tab-live" class="tab-content">
        <div class="controls">
          <button class="btn btn-danger" onclick="emergencyStop()">
            ğŸš¨ ê¸´ê¸‰ ì •ì§€
          </button>
          <button class="btn btn-primary" onclick="resetEmergency()">
            â–¶ï¸ ë§¤ë§¤ ì¬ê°œ
          </button>
          <button class="btn btn-outline" onclick="loadLiveTrading()">
            ğŸ”„ ë°ì´í„° ê°±ì‹ 
          </button>
        </div>

        <div class="stats-grid">
          <div class="card">
            <div class="stat-label">ì¼ì¼ ìˆ˜ìµê¸ˆ</div>
            <div class="stat-value" id="livePnl">$0.00</div>
          </div>
          <div class="card">
            <div class="stat-label">í˜„ì¬ ì”ê³ </div>
            <div class="stat-value" id="liveBalance">$0.00</div>
          </div>
          <div class="card">
            <div class="stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
            <div class="stat-value" id="liveTrades">0</div>
          </div>
        </div>

        <div class="table-area">
          <table>
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ì‹¬ë³¼</th>
                <th>ë°©í–¥</th>
                <th>ê°€ê²©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ì†ìµ</th>
              </tr>
            </thead>
            <tbody id="liveTradesBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- FREQTRADE TAB -->
      <div id="tab-freqtrade" class="tab-content">
        <div class="controls">
            <button class="btn btn-primary" onclick="sendFreqCommand('reload_config')">ğŸ”„ ì „ëµ ë¦¬ë¡œë“œ</button>
            <button class="btn btn-outline" onclick="window.open('http://localhost:8081', '_blank')">ğŸŒ ìƒˆ ì°½ì—ì„œ ì—´ê¸°</button>
            <span style="font-size: 0.8rem; color: var(--warning); margin-left: auto;">ğŸ”‘ Login: admin / admin</span>
        </div>

        <div class="iframe-scaler-container large">
            <iframe id="freqControlIframe" src="about:blank" class="scaled-iframe"></iframe>
        </div>
      </div>

      <!-- FREQTRADE BACKTEST TAB -->
      <div id="tab-freqbacktest" class="tab-content">
        <div class="controls">
            <button class="btn btn-primary" onclick="window.open('http://localhost:8082/#/backtest', '_blank')">ğŸŒ í° í™”ë©´ìœ¼ë¡œ ë³´ê¸°</button>
            <span style="font-size: 0.8rem; color: var(--warning); margin-left: auto;">ğŸ”‘ Dedicated Backtest Server (8082) | Login: admin / admin</span>
        </div>

        <div class="iframe-scaler-container large">
            <iframe id="freqBacktestIframe" src="about:blank" class="scaled-iframe"></iframe>
        </div>
      </div>

      <!-- EXPLORER TAB -->
      <div id="tab-explorer" class="tab-content">
        <div class="controls">
          <input
            type="text"
            id="stratSearch"
            placeholder="ì „ëµëª… ê²€ìƒ‰..."
            oninput="filterStrategies()"
          />
          <select id="gradeFilter" onchange="filterStrategies()">
            <option value="">ëª¨ë“  ë“±ê¸‰</option>
            <option value="A">A ë“±ê¸‰</option>
            <option value="B">B ë“±ê¸‰</option>
            <option value="C">C ë“±ê¸‰</option>
          </select>
          <button class="btn btn-outline" onclick="loadStrategies()">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <div class="table-area">
          <table>
            <thead>
              <tr>
                <th>ì „ëµëª…</th>
                <th>ì‘ì„±ì</th>
                <th>ì¢‹ì•„ìš”</th>
                <th>ì ìˆ˜</th>
                <th>ë“±ê¸‰</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="strategyExplorerBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- BACKTEST TAB -->
      <div id="tab-backtest" class="tab-content">
        <div class="card" style="max-width: 600px; margin-bottom: 32px">
          <h3 style="margin-bottom: 20px">ğŸ§ª ì‹ ê·œ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h3>
          <div style="display: flex; flex-direction: column; gap: 16px">
            <div class="input-group">
              <label>ëŒ€ìƒ ì „ëµ ì„ íƒ</label>
              <select id="btScriptId" style="width: 100%; border: 1px solid var(--border-color); background: var(--bg-deep); color: var(--text-primary); padding: 10px; border-radius: 8px;">
                <option value="">ì „ëµì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
              </select>
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px"
            >
              <div class="input-group">
                <label>ì‹¬ë³¼</label>
                <input type="text" id="btSymbol" value="BTC/USDT" />
              </div>
              <div class="input-group">
                <label>íƒ€ì„í”„ë ˆì„</label>
                <select id="btTimeframe">
                  <option value="1h" selected>1ì‹œê°„ (1h)</option>
                  <option value="4h">4ì‹œê°„ (4h)</option>
                  <option value="1d">1ì¼ (1d)</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" onclick="runBacktest()">
              ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            </button>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">ğŸ“Š ìµœê·¼ ë°±í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸</h3>
              <button class="btn btn-outline" style="padding: 4px 12px; font-size: 0.75rem;" onclick="loadBacktestReports()">ğŸ”„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ </button>
          </div>
          <div id="backtestReportsList">
            ë¡œë”© ì¤‘...
          </div>
        </div>
      </div>
    </div>

    <!-- Strategy Detail Modal -->
    <div id="strategyModal" class="modal-overlay">
      <div class="modal">
        <span class="modal-close" onclick="closeModal('strategyModal')"
          >&times;</span
        >
        <h2 id="modalTitle" style="margin-bottom: 8px">ì „ëµ ìƒì„¸ ë¶„ì„</h2>
        <p
          id="modalAuthor"
          color="var(--text-secondary)"
          style="margin-bottom: 24px"
        >
          By Author
        </p>

        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr)">
          <div class="card" style="padding: 16px">
            <div class="stat-label">AI ì´ì </div>
            <div class="stat-value" id="modalScore">0</div>
          </div>
          <div class="card" style="padding: 16px">
            <div class="stat-label">ë¦¬í˜ì¸íŒ… ë¶„ì„</div>
            <div id="modalRepaint" style="font-weight: 600">ì •ìƒ</div>
          </div>
          <div class="card" style="padding: 16px">
            <div class="stat-label">ê³¼ì í•© ìœ„í—˜</div>
            <div id="modalOverfit" style="font-weight: 600">ë‚®ìŒ</div>
          </div>
        </div>

        <div style="margin-top: 24px">
          <h4 style="margin-bottom: 12px">AI ë¶„ì„ ì˜ê²¬</h4>
          <div
            id="modalAnalysisText"
            style="
              padding: 16px;
              background: var(--bg-deep);
              border-radius: 12px;
              font-size: 0.9375rem;
              line-height: 1.6;
            "
          >
            ë¶„ì„ ë‚´ìš©ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "";
      let currentTab = "dashboard";
      let allStrategies = [];
      let apiKey = localStorage.getItem("api_key") || "admin";

      function switchTab(tabId) {
        console.log(`Switching to tab: ${tabId}`);
        document.querySelectorAll(".tab-content").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach((i) => i.classList.remove("active"));

        const targetTab = document.getElementById(`tab-${tabId}`);
        if (targetTab) {
            targetTab.classList.add("active");
            console.log(`Tab element found and activated: tab-${tabId}`);
        } else {
            console.warn(`Tab element NOT found: tab-${tabId}`);
        }
        
        const navItem = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
        if (navItem) navItem.classList.add("active");

        const titles = {
          dashboard: "ì¢…í•© ìƒíƒœ ëŒ€ì‹œë³´ë“œ",
          intelligence: "ë§ˆì¼“ ì¸í…”ë¦¬ì „ìŠ¤ AI",
          live: "ì‹¤ì „ ìë™ë§¤ë§¤ ëª¨ë‹ˆí„°ë§",
          freqtrade: "FreqControl - ë§¤ë§¤ ê´€ë¦¬",
          freqbacktest: "FreqBacktest - ì „ëµ ê²€ì¦ì†Œ",
          hummingbot: "Hummingbot - AMM & Arbitrage",
          cryptovision: "CryptoVision AI (HuggingFace)",
          messari: "Messari Professional Analysis",
          cryptopanic: "CryptoPanic High-Impact News",
          perplexity: "Perplexity Finance AI",
          explorer: "ì „ëµ íƒìƒ‰ ë° ë¶„ì„",
          backtest: "ì—°êµ¬ì†Œ ë°±í…ŒìŠ¤íŠ¸ (Pine)",
        };
        document.getElementById("tabTitle").innerText = titles[tabId] || "Trading Lab";
        currentTab = tabId;

        // Iframe / Data Loading
        if (tabId === 'freqtrade') {
            const ifr = document.getElementById('freqControlIframe');
            if (ifr && ifr.src === "about:blank") ifr.src = "http://localhost:8081/#/dashboard";
        } else if (tabId === 'freqbacktest') {
            const ifr = document.getElementById('freqBacktestIframe');
            if (ifr && ifr.src === "about:blank") ifr.src = "http://localhost:8082/#/backtest";
        } else if (tabId === 'hummingbot') {
            const ifr = document.getElementById('hummingbotIframe');
            if (ifr && ifr.src === "about:blank") ifr.src = "http://localhost:8501";
        } else if (tabId === 'cryptovision') {
            const ifr = document.getElementById('ifrCryptoVision');
            // Using the actual space app link for better embedding
            if (ifr && ifr.src === "about:blank") ifr.src = "https://openfree-cryptovision.hf.space/?__theme=dark";
        } else if (tabId === 'cryptopanic') {
            loadCryptoPanicNews();
        } else if (tabId === 'messari') {
            loadMessariAssets();
            loadMessariNews();
        } else if (tabId === 'perplexity') {
            loadPplxIndices();
            loadPplxMarketSummary();
        }

        refreshPageData();
    }

      async function refreshPageData() {
        updateHeartbeat();
        if (currentTab === "dashboard") {
          loadDashboardStats();
          loadTopStrategies();
          loadLiveStatus();
        } else if (currentTab === "intelligence") {
          loadIntelligenceData();
        } else if (currentTab === "live") {
          loadLiveTrading();
          loadLiveStatus();
        } else if (currentTab === "freqtrade") {
          loadFreqStatus();
          loadFreqStrategies();
        } else if (currentTab === "explorer") {
          loadStrategies();
        } else if (currentTab === "backtest") {
          loadStrategies();
          loadBacktestReports();
        }
      }

      async function updateHeartbeat() {
        try {
          const r = await fetch(`${API_BASE}/api/health`);
          const d = await r.json();
          document.getElementById("serverPulse").classList.remove("danger");
          document.getElementById("serverStatusText").innerText = "ì‹œìŠ¤í…œ ì •ìƒ";
          document.getElementById("lastUpdate").innerText = new Date().toLocaleTimeString();
        } catch (e) {
          document.getElementById("serverPulse").classList.add("danger");
          document.getElementById("serverStatusText").innerText = "ì—°ê²° ì§€ì—°";
        }
      }

      async function loadDashboardStats() {
        try {
          const r = await fetch(`${API_BASE}/api/stats`);
          const d = await r.json();
          document.getElementById("dashTotalStrats").innerText = d.total_strategies;
          document.getElementById("dashVerifiedStrats").innerText = d.passed_count;
        } catch (e) {}
        try {
          const r = await fetch(`${API_BASE}/api/trades/statistics`);
          const d = await r.json();
          if (d.success) {
            const pnl = d.statistics.daily_pnl || 0;
            const el = document.getElementById("dashPnl");
            el.innerText = `${pnl >= 0 ? "+" : ""}$${pnl.toLocaleString()}`;
            el.className = `stat-value ${pnl >= 0 ? "stat-profit" : "stat-loss"}`;
          }
        } catch (e) {}
      }

      async function loadTopStrategies() {
        try {
          const r = await fetch(`${API_BASE}/api/strategies?grade=B&limit=5&sort=score`);
          const data = await r.json();
          const container = document.getElementById("topStrategiesList");
          container.innerHTML = data.map(s => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600;">${s.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">By ${s.author}</div>
                    </div>
                    <span class="grade-badge grade-${s.grade.toLowerCase()}">${s.grade}</span>
                </div>
            `).join("");
        } catch (e) {
          document.getElementById("topStrategiesList").innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        }
      }

      async function loadLiveStatus() {
        try {
          const response = await fetch(`${API_BASE}/api/live/status`);
          const data = await response.json();
          if (data.success && data.status) {
            const s = data.status;
            if (s.safeguards) {
              const loss = (s.safeguards.daily_loss_limit * 100).toFixed(1) + "%";
              const pos = (s.safeguards.max_position_pct * 100).toFixed(1) + "%";
              const consec = (s.safeguards.consecutive_losses || 0) + "/" + (s.safeguards.max_consecutive_losses || 5);
              if (document.getElementById("dashLossLimit")) document.getElementById("dashLossLimit").innerText = loss;
              if (document.getElementById("dashPosLimit")) document.getElementById("dashPosLimit").innerText = pos;
              if (document.getElementById("dashConsecLimit")) document.getElementById("dashConsecLimit").innerText = consec;
            }
          }
        } catch (e) {}
      }

      async function loadLiveTrading() {
        try {
          const r = await fetch(`${API_BASE}/api/trades/recent?limit=10`);
          const d = await r.json();
          const tbody = document.getElementById("liveTradesBody");
          if (d.success && d.trades.length > 0) {
            tbody.innerHTML = d.trades.map(t => `
                <tr>
                    <td>${new Date(t.timestamp).toLocaleTimeString()}</td>
                    <td style="font-weight: 500;"><span class="source-tag source-${(t.source || 'custom').toLowerCase().substring(0,4)}">${t.source || 'CUST'}</span>${t.symbol}</td>
                    <td><span style="color: ${t.side === "buy" ? "var(--accent-primary)" : "var(--danger)"}">${t.side.toUpperCase()}</span></td>
                    <td>$${t.price.toLocaleString()}</td>
                    <td>${t.amount}</td>
                    <td class="${t.pnl >= 0 ? "stat-profit" : "stat-loss"}">${t.pnl ? (t.pnl >= 0 ? "+" : "") + "$" + t.pnl.toLocaleString() : "-"}</td>
                </tr>
            `).join("");
          } else {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          }
          const statsR = await fetch(`${API_BASE}/api/trades/statistics`);
          const statsD = await statsR.json();
          if (statsD.success) {
            document.getElementById("livePnl").innerText = `$${(statsD.statistics.daily_pnl || 0).toLocaleString()}`;
            document.getElementById("liveBalance").innerText = `$${(statsD.statistics.current_balance || 0).toLocaleString()}`;
            document.getElementById("liveTrades").innerText = statsD.statistics.total_trades;
          }
        } catch (e) {}
      }

      // Freqtrade í—¬í¼
      async function loadFreqStatus() {
          try {
              const r = await fetch(`${API_BASE}/api/freqtrade/status`);
              const d = await r.json();
              if (d.success) {
                  document.getElementById('freqStatus').innerText = d.status.toUpperCase();
                  document.getElementById('freqOpenTrades').innerText = d.open_trades_count;
                  document.getElementById('freqTotalProfit').innerText = (d.total_profit_abs >= 0 ? '+' : '') + '$' + d.total_profit_abs.toFixed(2);
                  
                  const posList = document.getElementById('freqPositionsList');
                  if (d.performance && d.performance.length > 0) {
                      posList.innerHTML = d.performance.map(p => `
                        <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">${p.pair}</span>
                            <span style="color: ${p.profit_pct >= 0 ? 'var(--accent-primary)' : 'var(--danger)'}">${(p.profit_pct >=0 ? '+' : '') + p.profit_pct}% ($${p.profit_abs})</span>
                        </div>
                      `).join('');
                  } else {
                      posList.innerHTML = '<p style="color: var(--text-secondary);">ì˜¤í”ˆëœ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                  }
              }
          } catch(e) {}
      }

      async function loadFreqStrategies() {
          try {
              const r = await fetch(`${API_BASE}/api/freqtrade/strategies`);
              const d = await r.json();
              const list = document.getElementById('freqStrategiesList');
              if (d.success && d.strategies.length > 0) {
                  list.innerHTML = d.strategies.map(s => `
                    <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ“„ ${s.name}</span>
                        <span style="font-size: 0.7rem; color: var(--text-secondary);">${new Date(s.last_modified).toLocaleDateString()}</span>
                    </div>
                  `).join('');
              } else {
                  list.innerHTML = '<p style="color: var(--text-secondary);">ë“±ë¡ëœ ì „ëµ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
              }
          } catch(e) {}
      }

      async function sendFreqCommand(cmd) {
          if (!confirm(`Freqtradeì— '${cmd}' ëª…ë ¹ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
          try {
              const r = await fetch(`${API_BASE}/api/freqtrade/command`, {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ command: cmd, api_key: apiKey })
              });
              const d = await r.json();
              alert(d.message);
              refreshPageData();
          } catch(e) { alert('ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨'); }
      }

      async function loadStrategies() {
        try {
          const r = await fetch(`${API_BASE}/api/strategies?limit=100`);
          allStrategies = await r.json();
          filterStrategies();
          
          // ë°±í…ŒìŠ¤íŠ¸ ì„ íƒì°½ ì—…ë°ì´íŠ¸
          const btSelect = document.getElementById("btScriptId");
          if (btSelect) {
              const currentVal = btSelect.value;
              btSelect.innerHTML = '<option value="">ì „ëµì„ ì„ íƒí•˜ì„¸ìš”...</option>' + 
                allStrategies.sort((a,b) => (b.total_score || 0) - (a.total_score || 0)).map(s => `<option value="${s.script_id}">${s.title} (${s.grade} - ${s.total_score || '0'}ì )</option>`).join("");
              if (currentVal) btSelect.value = currentVal;
          }
        } catch (e) {}
      }

      function filterStrategies() {
        const query = document.getElementById("stratSearch")?.value.toLowerCase() || "";
        const grade = document.getElementById("gradeFilter")?.value || "";
        const filtered = allStrategies.filter((s) => {
          const matchSearch = s.title.toLowerCase().includes(query) || s.author.toLowerCase().includes(query);
          const matchGrade = !grade || s.grade === grade;
          return matchSearch && matchGrade;
        });
        const tbody = document.getElementById("strategyExplorerBody");
        if (tbody) {
            tbody.innerHTML = filtered.map(s => `
                <tr>
                    <td style="font-weight: 500;">${s.title}</td>
                    <td>${s.author}</td>
                    <td>${s.likes}</td>
                    <td>${s.total_score || "-"}</td>
                    <td><span class="grade-badge grade-${s.grade?.toLowerCase() || "c"}">${s.grade || "C"}</span></td>
                    <td><button class="btn btn-outline" style="padding: 4px 8px; font-size: 0.75rem;" onclick="openStrategyDetail('${s.script_id}')">ìƒì„¸ë¶„ì„</button></td>
                </tr>
            `).join("");
        }
      }

      async function openStrategyDetail(id) {
        try {
          const r = await fetch(`${API_BASE}/api/strategy/${id}`);
          const s = await r.json();
          document.getElementById("modalTitle").innerText = s.title;
          document.getElementById("modalAuthor").innerText = `By ${s.author} | Liked ${s.likes}`;
          document.getElementById("modalScore").innerText = s.total_score || "-";
          document.getElementById("modalRepaint").innerText = s.repainting_score > 90 ? "ì•ˆì „" : "ìœ„í—˜";
          document.getElementById("modalRepaint").style.color = s.repainting_score > 90 ? "var(--accent-primary)" : "var(--danger)";
          document.getElementById("modalOverfit").innerText = s.overfitting_score > 70 ? "ë‚®ìŒ" : "ë†’ìŒ";
          document.getElementById("modalAnalysisText").innerText = s.analysis?.recommendation || "AI ë¶„ì„ ê²°ê³¼ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...";
          document.getElementById("strategyModal").style.display = "flex";
        } catch (e) {}
      }

      async function loadBacktestReports() {
        try {
          const r = await fetch(`${API_BASE}/api/backtest-charts`);
          const d = await r.json();
          const container = document.getElementById("backtestReportsList");
          if (d.charts && d.charts.length > 0) {
            container.innerHTML = d.charts.map(c => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid var(--border-color); background: rgba(255,255,255,0.02); margin-bottom: 10px; border-radius: 12px; transition: all 0.2s; border: 1px solid transparent;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-weight: 700; color: var(--text-primary); font-size: 1rem;">${c.strategy.toUpperCase()}</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="source-tag source-freq" style="font-size: 0.65rem;">REPORT</span>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">${c.symbol || 'BTC/USDT'}</span>
                        </div>
                    </div>
                    <a href="${c.url}" target="_blank" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem; text-decoration: none; border-radius: 8px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);">ë¶„ì„ ì°¨íŠ¸ ì—´ê¸° ğŸ“ˆ</a>
                </div>
            `).join("");
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary); border: 1px dashed var(--border-color); border-radius: 12px;">ìµœê·¼ ìƒì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ ë³´ì„¸ìš”.</div>';
          }
        } catch (e) {
            document.getElementById("backtestReportsList").innerHTML = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨';
        }
      }

      async function runBacktest() {
        const script_id = document.getElementById("btScriptId").value;
        const symbol = document.getElementById("btSymbol").value;
        const timeframe = document.getElementById("btTimeframe").value;
        if (!script_id) return alert("ì „ëµ IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        alert(`${script_id} ì „ëµì— ëŒ€í•œ ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
        try {
          const r = await fetch(`${API_BASE}/api/backtest`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ script_id, symbol, timeframe }),
          });
          const d = await r.json();
          if (d.success) {
            alert("ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ!");
            loadBacktestReports();
          } else alert("ì‹¤íŒ¨: " + d.error);
        } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜"); }
      }

      function promptApiKey() {
        const key = prompt("ë³´ì•ˆ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", apiKey);
        if (key) {
          apiKey = key;
          localStorage.setItem("api_key", apiKey);
          document.getElementById("apiKeyLabel").innerText = "í‚¤ ì„¤ì • ì™„ë£Œ";
        }
      }

      async function emergencyStop() {
        if (!confirm("ğŸš¨ ëª¨ë“  ìë™ë§¤ì¹˜ë¥¼ ì¦‰ì‹œ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          const r = await fetch(`${API_BASE}/api/emergency-stop`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ api_key: apiKey, reason: "ì‚¬ìš©ì ê¸´ê¸‰ ì •ì§€" }),
          });
          const d = await r.json();
          if (d.success) alert("ê¸´ê¸‰ ì •ì§€ ì™„ë£Œ");
          else alert("ì‹¤íŒ¨: " + d.error);
        } catch (e) {}
      }

      async function resetEmergency() {
        try {
          const r = await fetch(`${API_BASE}/api/emergency-stop/reset`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ api_key: apiKey }),
          });
          const d = await r.json();
          if (d.success) alert("ì‹œìŠ¤í…œ ì¬ê°œ ì™„ë£Œ");
          else alert("ì‹¤íŒ¨: " + d.error);
        } catch (e) {}
      }

      async function loadCryptoPanicNews() {
        const container = document.getElementById("cryptoPanicLiveList");
        const statusEl = document.getElementById("cpStatus");
        const filterEl = document.getElementById("cpFilter");
        const filter = filterEl ? filterEl.value : "hot";

        if (statusEl) {
          statusEl.textContent = "LOADING...";
          statusEl.className = "grade-badge grade-c";
        }

        try {
          const r = await fetch(`${API_BASE}/api/external/cryptopanic?filter=${filter}&currencies=BTC,ETH,SOL`);
          const d = await r.json();

          if (d.success && d.news) {
            if (statusEl) {
              statusEl.textContent = d.count + " NEWS";
              statusEl.className = "grade-badge grade-a";
            }

            let html = '';
            d.news.forEach(post => {
              const currencies = post.currencies ? post.currencies.map(c => '<span style="font-size:0.7rem; color:#aaa; border:1px solid #333; padding:2px 8px; border-radius:4px;">' + escapeHtml(c) + '</span>').join('') : '';
              const votes = post.votes && post.votes.positive ? '<span style="font-size:0.7rem; color:var(--accent-emerald);">ğŸ‘ ' + post.votes.positive + '</span>' : '';
              html += '<div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">' +
                '<div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 10px;">' +
                '<a href="' + escapeHtml(post.url) + '" target="_blank" style="font-weight:600; color:#fff; flex:1; margin-right:12px; text-decoration: none; line-height: 1.4;">' + escapeHtml(post.title) + '</a>' +
                '<span style="font-size:0.7rem; color:var(--text-secondary); white-space:nowrap;">' + new Date(post.created_at).toLocaleTimeString() + '</span>' +
                '</div>' +
                '<div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">' +
                '<span style="font-size:0.75rem; color:var(--accent-emerald); background:rgba(16,185,129,0.1); padding:3px 10px; border-radius:6px;">' + escapeHtml(post.source) + '</span>' +
                currencies + votes +
                '</div></div>';
            });
            container.innerHTML = html;
          } else {
            throw new Error(d.error || "Failed to load");
          }
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = "ERROR";
            statusEl.className = "grade-badge grade-c";
          }
          container.innerHTML = '<div style="text-align:center; padding: 40px;"><p style="margin-bottom:20px; color: var(--danger);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p><a href="https://cryptopanic.com/" target="_blank" class="btn btn-primary">CryptoPanicì—ì„œ ë‰´ìŠ¤ ë³´ê¸° â†—</a></div>';
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„ ìœ í‹¸ë¦¬í‹°
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ============ MESSARI FUNCTIONS ============
      async function loadMessariAssets() {
        const tbody = document.getElementById("messariAssetsBody");
        const statusEl = document.getElementById("messariStatus");

        if (statusEl) {
          statusEl.textContent = "LOADING...";
          statusEl.className = "grade-badge grade-c";
        }

        try {
          const r = await fetch(`${API_BASE}/api/external/messari/assets?limit=20`);
          const d = await r.json();

          if (d.success && d.assets) {
            if (statusEl) {
              statusEl.textContent = d.count + " ASSETS";
              statusEl.className = "grade-badge grade-a";
            }

            let html = '';
            d.assets.forEach(asset => {
              const price = asset.price_usd ? '$' + asset.price_usd.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: asset.price_usd < 1 ? 6 : 2}) : '-';
              const changeColor = asset.percent_change_24h >= 0 ? 'var(--accent-emerald)' : 'var(--danger)';
              const change = asset.percent_change_24h ? (asset.percent_change_24h >= 0 ? '+' : '') + asset.percent_change_24h.toFixed(2) + '%' : '-';
              const volume = asset.volume_24h ? '$' + (asset.volume_24h / 1e9).toFixed(2) + 'B' : '-';
              const mcap = asset.market_cap ? '$' + (asset.market_cap / 1e9).toFixed(2) + 'B' : '-';

              html += '<tr>' +
                '<td style="font-weight: 600;"><span style="color: var(--accent-primary);">' + escapeHtml(asset.symbol) + '</span> <span style="color: var(--text-secondary); font-size: 0.8rem;">' + escapeHtml(asset.name) + '</span></td>' +
                '<td>' + price + '</td>' +
                '<td style="color: ' + changeColor + '; font-weight: 600;">' + change + '</td>' +
                '<td style="color: var(--text-secondary);">' + volume + '</td>' +
                '<td style="color: var(--text-secondary);">' + mcap + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;
          } else {
            throw new Error(d.error || "Failed to load");
          }
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = "ERROR";
            statusEl.className = "grade-badge grade-c";
          }
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--danger);">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
        }
      }

      async function loadMessariNews() {
        const container = document.getElementById("messariNewsList");

        try {
          const r = await fetch(`${API_BASE}/api/external/messari/news`);
          const d = await r.json();

          if (d.success && d.news) {
            let html = '';
            d.news.forEach(item => {
              const author = item.author ? '<span style="font-size: 0.75rem; color: var(--text-secondary);">By ' + escapeHtml(item.author) + '</span>' : '';
              const tags = item.tags ? item.tags.slice(0, 3).map(t => '<span style="font-size: 0.7rem; background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px;">' + escapeHtml(t) + '</span>').join('') : '';

              html += '<div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">' +
                '<a href="' + escapeHtml(item.url) + '" target="_blank" style="font-weight: 600; color: #fff; text-decoration: none; line-height: 1.4; display: block; margin-bottom: 8px;">' + escapeHtml(item.title) + '</a>' +
                '<p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 8px;">' + escapeHtml(item.content || '') + '</p>' +
                '<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">' + author + tags + '</div></div>';
            });
            container.innerHTML = html;
          } else {
            throw new Error(d.error || "Failed to load");
          }
        } catch (e) {
          container.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--danger);">ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨</div>';
        }
      }

      // ============ PERPLEXITY FINANCE FUNCTIONS ============
      function switchPplxTab(tab) {
        document.querySelectorAll('.pplx-tab').forEach(t => {
          t.style.borderBottom = 'none';
          t.style.color = 'var(--text-secondary)';
        });
        const activeTab = document.querySelector('[data-pplx-tab="' + tab + '"]');
        if (activeTab) {
          activeTab.style.borderBottom = '2px solid var(--accent-primary)';
          activeTab.style.color = 'var(--text-primary)';
        }
      }

      async function loadPplxIndices() {
        try {
          const r = await fetch(`${API_BASE}/api/external/messari/assets?limit=10`);
          const d = await r.json();

          if (d.success && d.assets) {
            const btc = d.assets.find(a => a.symbol === 'BTC');
            const eth = d.assets.find(a => a.symbol === 'ETH');
            const sol = d.assets.find(a => a.symbol === 'SOL');

            if (btc) updateIndexCard('Btc', btc);
            if (eth) updateIndexCard('Eth', eth);
            if (sol) updateIndexCard('Sol', sol);
          }

          // Load Fear & Greed Index
          const fgResp = await fetch(`${API_BASE}/api/external/fear-greed`);
          const fgData = await fgResp.json();
          if (fgData.success) {
            updateFearGreedIndex(fgData);
          }
        } catch (e) {
          console.error('Failed to load indices:', e);
        }
      }

      function updateFearGreedIndex(data) {
        const valueEl = document.getElementById('pplxFgValue');
        const labelEl = document.getElementById('pplxFgLabel');
        const pointerEl = document.getElementById('pplxFgPointer');
        const sentimentEl = document.getElementById('pplxSentimentLabel');

        if (valueEl) valueEl.textContent = data.value;
        if (labelEl) labelEl.textContent = data.classification;

        // ìƒ‰ìƒ ì„¤ì •
        let color = 'var(--warning)';
        if (data.value < 25) color = 'var(--danger)';
        else if (data.value > 75) color = 'var(--accent-emerald)';

        if (labelEl) labelEl.style.color = color;

        // í¬ì¸í„° ìœ„ì¹˜ ì¡°ì • (0-100 ë²”ìœ„ë¥¼ 0%-100%ë¡œ)
        if (pointerEl) pointerEl.style.left = data.value + '%';

        // ìƒë‹¨ ê°ì • ë¼ë²¨ ì—…ë°ì´íŠ¸
        if (sentimentEl) {
          sentimentEl.textContent = data.classification === 'Fear' ? 'ë¹„ê´€ì  ê°ì •' :
                                    data.classification === 'Greed' ? 'ë‚™ê´€ì  ê°ì •' : 'ì¤‘ë¦½ ê°ì •';
          sentimentEl.style.color = color;
        }
      }

      function updateIndexCard(prefix, data) {
        const priceEl = document.getElementById('pplx' + prefix + 'Price');
        const changeEl = document.getElementById('pplx' + prefix + 'Change');
        const diffEl = document.getElementById('pplx' + prefix + 'Diff');
        const chartEl = document.getElementById('pplx' + prefix + 'Chart');

        if (priceEl && data.price_usd) {
          priceEl.textContent = 'US$' + data.price_usd.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        if (changeEl && data.percent_change_24h !== undefined) {
          const isPositive = data.percent_change_24h >= 0;
          changeEl.textContent = (isPositive ? 'â†— +' : 'â†˜ ') + data.percent_change_24h.toFixed(2) + '%';
          changeEl.style.color = isPositive ? 'var(--accent-emerald)' : 'var(--danger)';

          if (diffEl) {
            const diff = data.price_usd * (data.percent_change_24h / 100);
            diffEl.textContent = (isPositive ? '+' : '-') + 'US$' + Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            diffEl.style.color = isPositive ? 'var(--accent-emerald)' : 'var(--danger)';
          }

          if (chartEl) {
            chartEl.style.background = isPositive ?
              'linear-gradient(180deg, rgba(16,185,129,0.15) 0%, transparent 100%)' :
              'linear-gradient(180deg, rgba(255,77,77,0.15) 0%, transparent 100%)';
          }
        }
      }

      async function loadPplxMarketSummary() {
        const container = document.getElementById("pplxMarketSummary");
        const timeEl = document.getElementById("pplxSummaryTime");

        try {
          const r = await fetch(`${API_BASE}/api/external/perplexity/market-brief`);
          const d = await r.json();

          if (d.success && d.brief) {
            if (timeEl) timeEl.textContent = 'ì—…ë°ì´íŠ¸ë¨ ' + new Date(d.generated_at).toLocaleTimeString();

            // ì‹œì¥ ìš”ì•½ì„ ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
            const lines = d.brief.split('\n').filter(l => l.trim());
            let html = '';
            lines.forEach((line, i) => {
              if (line.trim()) {
                html += '<div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="toggleSummaryItem(this)">' +
                  '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                  '<span style="font-weight: 500;">' + escapeHtml(line.substring(0, 80)) + (line.length > 80 ? '...' : '') + '</span>' +
                  '<span style="color: var(--text-secondary);">âˆ¨</span></div>' +
                  '<div class="summary-detail" style="display: none; margin-top: 12px; color: var(--text-secondary); line-height: 1.6;">' + escapeHtml(line) + '</div></div>';
              }
            });
            container.innerHTML = html || '<div style="padding: 20px; text-align: center;">ìš”ì•½ ë°ì´í„° ì—†ìŒ</div>';
          } else {
            throw new Error(d.error || "Failed");
          }
        } catch (e) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ì‹œì¥ ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <button class="btn btn-outline" style="margin-left: 12px; padding: 6px 12px; font-size: 0.8rem;" onclick="loadPplxMarketSummary()">ë‹¤ì‹œ ì‹œë„</button></div>';
        }
      }

      function toggleSummaryItem(el) {
        const detail = el.querySelector('.summary-detail');
        if (detail) {
          detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
        }
      }

      let pplxChatHistory = [];

      async function askPerplexity() {
        const input = document.getElementById("pplxQuery");
        const responseArea = document.getElementById("pplxResponseArea");
        const container = document.getElementById("pplxChatHistory");
        const statusEl = document.getElementById("pplxChatStatus");
        const query = input.value.trim();

        if (!query) return;

        responseArea.style.display = 'block';
        pplxChatHistory.push({ role: 'user', content: query });
        renderChatHistory();
        input.value = '';

        if (statusEl) {
          statusEl.textContent = "THINKING...";
          statusEl.className = "grade-badge grade-c";
        }

        try {
          const r = await fetch(`${API_BASE}/api/external/perplexity/ask`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });
          const d = await r.json();

          if (d.success && d.answer) {
            pplxChatHistory.push({ role: 'assistant', content: d.answer, citations: d.citations });
            renderChatHistory();
            if (statusEl) {
              statusEl.textContent = "READY";
              statusEl.className = "grade-badge grade-a";
            }
          } else {
            throw new Error(d.error || "Failed to get response");
          }
        } catch (e) {
          pplxChatHistory.push({ role: 'error', content: 'ì˜¤ë¥˜: ' + e.message });
          renderChatHistory();
          if (statusEl) {
            statusEl.textContent = "ERROR";
            statusEl.className = "grade-badge grade-c";
          }
        }
      }

      function renderChatHistory() {
        const container = document.getElementById("pplxChatHistory");
        if (pplxChatHistory.length === 0) {
          container.innerHTML = '<div style="text-align:center; color: var(--text-secondary); padding: 40px;"><p>ì•”í˜¸í™”í ë° ê¸ˆìœµ ì‹œì¥ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”.</p></div>';
          return;
        }

        let html = '';
        pplxChatHistory.forEach(msg => {
          if (msg.role === 'user') {
            html += '<div style="display: flex; justify-content: flex-end; margin-bottom: 12px;"><div style="background: var(--accent-primary); color: #000; padding: 12px 16px; border-radius: 16px 16px 4px 16px; max-width: 80%; font-weight: 500;">' + escapeHtml(msg.content) + '</div></div>';
          } else if (msg.role === 'assistant') {
            html += '<div style="display: flex; justify-content: flex-start; margin-bottom: 12px;"><div style="background: rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 16px 16px 16px 4px; max-width: 85%; line-height: 1.6; white-space: pre-wrap;">' + escapeHtml(msg.content) + '</div></div>';
          } else {
            html += '<div style="display: flex; justify-content: flex-start; margin-bottom: 12px;"><div style="background: rgba(255,77,77,0.2); color: var(--danger); padding: 12px 16px; border-radius: 12px;">' + escapeHtml(msg.content) + '</div></div>';
          }
        });
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      }

      function setQuickQuery(query) {
        document.getElementById("pplxQuery").value = query;
        askPerplexity();
      }

      async function loadIntelligenceData() {
        try {
          // Sentiment fetch
          const r1 = await fetch(`${API_BASE}/api/intelligence/sentiment`);
          const d1 = await r1.json();
          if (d1.success) {
            document.getElementById("intelSentimentStatus").innerText = d1.status.toUpperCase();
            document.getElementById("intelSentimentStatus").style.color = d1.status === "Bullish" ? "var(--accent-emerald)" : d1.status === "Bearish" ? "var(--danger)" : "var(--text-primary)";
            document.getElementById("intelSentimentIndex").innerText = `CryptoBERT Index: ${d1.index} | ${d1.source}`;
            document.getElementById("intelSummary").innerText = d1.summary;
          }

          // News fetch
          const r2 = await fetch(`${API_BASE}/api/intelligence/news`);
          const d2 = await r2.json();
          if (d2.success) {
            const container = document.getElementById("intelNewsList");
            container.innerHTML = d2.news.map(n => `
              <div style="display: flex; gap: 16px; align-items: center; padding: 14px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem;">
                <span style="color: var(--text-secondary); width: 60px; font-size: 0.8rem;">${n.time}</span>
                <span style="flex: 1; font-weight: 500; color: #fff;">${n.title}</span>
                <span style="background: ${n.impact === 'High' ? 'rgba(255,77,77,0.1)' : 'rgba(255,255,255,0.05)'}; color: ${n.impact === 'High' ? 'var(--danger)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${n.impact}</span>
                <span style="color: #666; font-size: 0.8rem;">${n.source}</span>
              </div>
            `).join("");
          }
        } catch (e) {
            console.error("Intelligence load failed", e);
        }
      }

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      setInterval(refreshPageData, 10000);
      refreshPageData();
      
      // Initialize
      loadStrategies();
    </script>
  </body>
</html>
