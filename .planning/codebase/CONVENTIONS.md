# Coding Conventions

**Analysis Date:** 2026-01-19

## Naming Patterns

**Files:**
- Snake_case for Python modules: `repainting_detector.py`, `strategy_generator.py`, `backtest_engine.py`
- Descriptive names: `pine_to_python.py`, `human_like_scraper.py`, `live_safeguards.py`
- Test files: `test_*.py` pattern (e.g., `test_api.py`, `test_overfitting_detector.py`)
- Strategy files: `{name}_strategy.py` pattern generated by `StrategyGenerator`

**Functions:**
- Snake_case: `analyze_strategy()`, `generate_signal()`, `get_db()`
- Action verbs: `sanitize_input()`, `validate_script_id()`, `parse_json_field()`
- Async functions prefixed naturally: `async def score_strategy()`, `async def get_stats()`

**Variables:**
- Snake_case: `pine_code`, `total_score`, `risk_level`, `strategy_code`
- Descriptive: `repainting_score`, `overfitting_score`, `backtest_result`
- Constants: UPPER_CASE for config values in classes: `WEIGHTS`, `CRITICAL_PATTERNS`, `GRADE_THRESHOLDS`

**Classes:**
- PascalCase: `StrategyScorer`, `RepaintingDetector`, `BacktestEngine`, `StrategyGenerator`
- Descriptive suffixes: `*Detector`, `*Analyzer`, `*Generator`, `*Manager`, `*Collector`
- Enums: PascalCase with UPPER_CASE values: `RepaintingRisk.CRITICAL`, `SignalType.LONG`

**Types:**
- PascalCase dataclasses: `FinalScore`, `BacktestResult`, `StrategyMeta`
- Pydantic models: PascalCase with `Response` or `Request` suffix: `StatsResponse`, `BacktestRequest`

## Code Style

**Formatting:**
- Tool: Black (inferred from requirements.txt)
- Line length: No strict limit observed (some lines exceed 100 characters)
- Indentation: 4 spaces
- Quotes: Double quotes preferred in API server, mixed in other files

**Linting:**
- Tools available: mypy, ruff (from requirements.txt)
- Type hints used extensively in newer code
- Not enforced strictly across entire codebase

**Docstrings:**
- Module-level docstrings at top of most files (triple-quoted strings)
- Function docstrings in key modules like indicators: multi-line with Args/Returns sections
- Class docstrings for major components
- Korean comments used extensively for business logic explanations

## Import Organization

**Order:**
1. Standard library imports
2. Third-party imports (pandas, numpy, FastAPI, etc.)
3. Local project imports (from `src.*`)

**Pattern Example from `api/server.py`:**
```python
import json
import sqlite3
import logging
from pathlib import Path
from typing import Optional, List

from fastapi import FastAPI, Query
from pydantic import BaseModel

from src.config import Config
```

**Path Aliases:**
- No path aliases configured
- Relative imports used within packages: `from .rule_based.repainting_detector import ...`
- Absolute imports from `src`: `from src.analyzer import StrategyScorer`

**Common Pattern:**
- sys.path manipulation used in scripts: `sys.path.insert(0, str(Path(__file__).parent.parent))`

## Error Handling

**Patterns:**
- Try-except blocks wrap external API calls and database operations
- HTTPException used in FastAPI endpoints with status codes and detail messages
- Logging before re-raising: `logger.error(f"Error: {e}", exc_info=True)`
- Graceful degradation: Return default values or empty results on non-critical failures

**Examples:**
```python
# API error handling
try:
    conn = get_db()
    # ... database operations
except sqlite3.Error as e:
    raise HTTPException(status_code=500, detail=f"Database error: {str(e)}")

# LLM analysis failure (non-critical)
try:
    llm_analysis = await self.llm_analyzer.analyze_strategy(...)
except Exception as e:
    logger.error(f"LLM analysis failed: {e}")
    llm_score = 50  # default value
```

**Validation:**
- Input sanitization in API: `sanitize_input()` removes dangerous characters
- Pydantic models for request validation
- Manual validation for critical fields: `validate_script_id()`

## Logging

**Framework:** Python standard `logging` module

**Setup Pattern:**
```python
import logging

logger = logging.getLogger(__name__)
# or for specific module:
logger = logging.getLogger("api")
```

**Log Levels:**
- `logger.info()` - Normal operations, successful actions
- `logger.warning()` - Non-critical issues, potential problems
- `logger.error()` - Errors requiring attention, includes `exc_info=True` for tracebacks
- `logger.debug()` - Not extensively used

**Structured Logging:**
- JSON formatter used in API server: `api.json.log`
- RotatingFileHandler with 10MB max size, 5 backups
- Log format: `%(asctime)s | %(levelname)-8s | %(name)s | %(message)s`

**Patterns:**
- F-strings for log messages: `logger.info(f"Request: {method} {path}")`
- Korean messages for business logic: `logger.info("ðŸš€ AI ê²€ì¦ ìžë™ë§¤ë§¤ ë´‡ ì‹œìž‘")`
- Emojis used in trading bot logs for visibility

## Comments

**When to Comment:**
- Business logic explanations in Korean
- Complex algorithm steps numbered: `# 1. ì¹˜ëª…ì  íŒ¨í„´ ê²€ì‚¬`, `# 2. ê³ ìœ„í—˜ íŒ¨í„´ ê²€ì‚¬`
- Warnings about critical operations: `# ì¹˜ëª…ì ì´ë©´ ë°”ë¡œ ë°˜í™˜`
- Code section dividers: `# ============================================================`

**JSDoc/TSDoc:**
- Not applicable (Python codebase)
- Type hints used instead: `def analyze(self, pine_code: str) -> RepaintingAnalysis:`

**Docstring Style:**
```python
def SMA(data: pd.Series, period: int = 20) -> pd.Series:
    """
    Simple Moving Average (ë‹¨ìˆœ ì´ë™í‰ê· )

    Args:
        data: ê°€ê²© ë°ì´í„° (ì¼ë°˜ì ìœ¼ë¡œ Close)
        period: ì´ë™í‰ê·  ê¸°ê°„

    Returns:
        SMA ê°’
    """
```

**TODO/FIXME:**
- Found in some files but not systematic
- Korean task descriptions in some comments

## Function Design

**Size:**
- Small focused functions preferred: Most under 50 lines
- Some complex functions exceed 100 lines (e.g., trading bot logic)
- Test fixtures kept minimal

**Parameters:**
- Type-annotated: `def analyze(self, pine_code: str) -> RepaintingAnalysis:`
- Default values for optional params: `period: int = 20`, `skip_llm: bool = False`
- Keyword arguments preferred for readability
- Dataclasses used for complex param groups: `BacktestConfig`, `TraderConfig`

**Return Values:**
- Type-annotated return types
- Dataclasses for structured returns: `RepaintingAnalysis`, `FinalScore`, `BacktestResult`
- Dicts for flexible data: `{"success": True, "data": ...}`
- Optional types for nullable returns: `Optional[Dict]`

**Async Functions:**
- `async def` for I/O operations: API calls, database queries
- `await` used consistently
- No mixed sync/async (clear separation)

## Module Design

**Exports:**
- `__init__.py` files define public API:
```python
# src/backtester/__init__.py
from .backtest_engine import BacktestEngine, BacktestResult
from .data_collector import BinanceDataCollector
```

**Barrel Files:**
- Used in package `__init__.py` to expose key classes
- Example: `src/analyzer/__init__.py` exports `StrategyScorer`

**Module Structure:**
- Single responsibility: One analyzer/detector per file
- Related utilities grouped: `src/indicators/trend.py` contains all trend indicators
- Separation of concerns: `rule_based/` vs `llm/` analyzers

## Configuration

**Pattern:** Pydantic Settings
```python
# src/config.py
class Config(BaseSettings):
    model_config = {
        "env_file": ".env",
        "case_sensitive": False
    }

    openai_api_key: Optional[str] = None
    db_path: str = "data/strategies.db"
```

**Environment Variables:**
- Loaded via pydantic-settings
- Optional with defaults: `os.getenv("API_SECRET_KEY", "")`
- Type conversion handled by Pydantic

## Testing Patterns

**Fixtures:**
- Pytest fixtures in `conftest.py`
- Sample Pine scripts as fixtures: `sample_pine_script_safe`, `sample_pine_script_repainting`
- Mock data fixtures: `mock_strategy_meta`, `mock_performance_good`
- Temp paths: `temp_db_path(tmp_path)`

**Test Organization:**
- Class-based tests: `class TestHealthEndpoint:`, `class TestStrategyGenerator:`
- Descriptive test names: `test_strategy_not_found()`, `test_normalize_code_lowercase()`
- Setup in `@pytest.fixture(autouse=True)` or class setup methods

**Assertions:**
- Standard assert statements
- Response validation: `assert response.status_code == 200`
- Data structure checks: `assert "strategy_file" in result`

---

*Convention analysis: 2026-01-19*
